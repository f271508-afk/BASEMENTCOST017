<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地下室工程造價概算系統 v57.1.0 - Excel 整合版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 引入 XLSX 函式庫 -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .method-tab-active { background-color: #4338ca; color: white; transform: translateY(-1px); shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .region-tab-active { border-color: #4338ca; background-color: #eef2ff; color: #4338ca; font-weight: 900; }
        .modal-bg { background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 p-4 md:p-8">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-start justify-between mb-8 gap-6 border-b pb-8 border-slate-200">
            <div class="space-y-3">
                <div class="flex items-center gap-2 text-indigo-600 font-black text-xs tracking-widest uppercase">
                    <span class="bg-indigo-600 text-white px-2 py-0.5 rounded">PRO</span> Version 57.1.0
                </div>
                <h1 class="text-3xl font-black text-slate-800 flex items-center gap-3">
                    <i data-lucide="building-2" class="text-indigo-700 w-8 h-8"></i>
                    地下室工程造價概算系統
                </h1>
                <div class="flex flex-wrap gap-3 text-[10px] font-black">
                    <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full border border-slate-200 text-slate-500 shadow-sm">
                        <i data-lucide="user" class="text-indigo-500 w-3 h-3"></i> UID: <span id="uid-display" class="font-mono text-indigo-700">OFFLINE</span>
                    </div>
                </div>
            </div>
            <div class="text-right bg-white p-6 rounded-3xl border border-slate-200 shadow-xl min-w-[280px]">
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-wider mb-1">工程總造價預估 (未稅)</p>
                <p id="total-budget" class="text-4xl font-black text-indigo-700 leading-none tracking-tighter mb-3">0元</p>
                <div class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-lg inline-flex items-center gap-2">
                    <span class="text-[10px] font-black uppercase">平均單坪:</span>
                    <span id="avg-cost" class="text-sm font-black">0元</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- 左側輸入 -->
            <section class="lg:col-span-5 space-y-6">
                <!-- 區域選擇 -->
                <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                    <div class="bg-indigo-700 p-5 flex items-center justify-between text-white">
                        <div class="flex items-center gap-3">
                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                            <h3 class="text-sm font-black uppercase tracking-widest">區域單價庫</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- XLSX 匯入/匯出按鈕 -->
                            <button onclick="exportToExcel()" title="匯出 Excel" class="bg-white/10 hover:bg-white/20 p-1.5 rounded-lg transition-colors">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                            <label class="bg-white/10 hover:bg-white/20 p-1.5 rounded-lg transition-colors cursor-pointer" title="匯入 Excel">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                <input type="file" id="import-excel" class="hidden" accept=".xlsx, .xls" onchange="importFromExcel(event)">
                            </label>
                            <button onclick="openRegionModal()" class="bg-white/20 hover:bg-white/30 p-1.5 rounded-lg transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="region-list" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- 規模工法 -->
                <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                    <div class="bg-slate-900 p-5 flex items-center gap-3 text-white">
                        <i data-lucide="settings" class="w-5 h-5 text-indigo-400"></i>
                        <h3 class="text-sm font-black uppercase">1. 規模與基本設定</h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="space-y-2">
                            <label class="text-[10px] font-black uppercase text-slate-400">擋土工法選擇</label>
                            <div class="flex bg-slate-100 p-1 rounded-xl gap-1">
                                <button onclick="updateState('retainingMethod', 'wall')" id="btn-method-wall" class="flex-1 py-2 text-xs font-black rounded-lg transition-all">連續壁</button>
                                <button onclick="updateState('retainingMethod', 'pile')" id="btn-method-pile" class="flex-1 py-2 text-xs font-black rounded-lg transition-all">排樁</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-5">
                            <div class="input-group" data-label="地下單層面積" data-unit="坪" data-key="belowUnitArea"></div>
                            <div class="input-group" data-label="地下總層數" data-unit="層" data-key="belowFloors"></div>
                        </div>
                        <div class="input-group" data-label="地下建築週長" data-unit="m" data-key="belowPerimeter"></div>
                    </div>
                </div>

                <!-- 分層結構用量 -->
                <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                    <div class="bg-emerald-600 p-5 flex items-center gap-3 text-white">
                        <i data-lucide="layout-grid" class="w-5 h-5"></i>
                        <h3 class="text-sm font-black uppercase">2. 分層結構用量參數 (m²)</h3>
                    </div>
                    <div class="p-6 space-y-6" id="layer-usage-inputs"></div>
                </div>
            </section>

            <!-- 右側報表與單價設定 -->
            <section class="lg:col-span-7 space-y-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="physics-cards"></div>

                <!-- 預算表 -->
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase border-b">
                            <tr><th class="px-8 py-4">預算大項</th><th class="px-8 py-4">細部說明</th><th class="px-8 py-4 text-right">概算金額</th></tr>
                        </thead>
                        <tbody id="budget-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>

                <!-- 單價細項編輯 -->
                <div class="bg-[#0f172a] text-white p-8 rounded-[40px] shadow-2xl space-y-8">
                    <div class="flex items-center justify-between">
                        <h4 class="text-xl font-black text-white">區域細項單價設定</h4>
                        <div class="flex gap-2">
                             <button onclick="editRegionName()" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-full transition-all">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteCurrentRegion()" class="p-2 bg-rose-900/50 hover:bg-rose-800 text-rose-400 rounded-full transition-all">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest -mt-4">目前編輯：<span id="current-region-label" class="text-white">載入中</span></p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                        <div class="space-y-4">
                            <h5 class="text-[11px] font-black text-slate-400 flex items-center gap-2 mb-4"><i data-lucide="layers" class="w-4 h-4"></i> 擋土工程細項</h5>
                            <div id="retaining-rates-list" class="space-y-3"></div>
                        </div>
                        <div class="space-y-4">
                            <h5 class="text-[11px] font-black text-rose-400 flex items-center gap-2 mb-4"><i data-lucide="anchor" class="w-4 h-4"></i> 支撐與構台</h5>
                            <div id="support-params-list" class="space-y-3"></div>
                        </div>
                    </div>
                    <div class="pt-8 border-t border-slate-800">
                        <h5 class="text-[11px] font-black text-emerald-400 flex items-center gap-2 mb-6"><i data-lucide="box" class="w-4 h-4"></i> 結構材單價與雜項</h5>
                        <div id="structural-rates-list" class="grid grid-cols-2 md:grid-cols-3 gap-x-10 gap-y-4"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- 彈窗: 新增區域 -->
    <div id="region-modal" class="fixed inset-0 modal-bg z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[32px] w-full max-w-md overflow-hidden shadow-2xl">
            <div class="bg-indigo-700 p-6 text-white flex justify-between items-center">
                <h3 class="font-black text-lg">新增區域單價庫</h3>
                <button onclick="closeRegionModal()"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <div class="space-y-2">
                    <label class="text-xs font-black text-slate-400 uppercase">區域名稱</label>
                    <input type="text" id="new-region-name" class="w-full border-2 border-slate-100 rounded-2xl px-5 py-3 outline-none focus:border-indigo-500 font-bold" placeholder="例如：新竹區">
                </div>
                <button onclick="confirmAddRegion()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl">建立區域</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full text-xs font-black shadow-2xl opacity-0 transition-opacity pointer-events-none z-50"></div>

    <script>
        const PING_TO_M2 = 3.3058;
        const DEFAULT_PARAMS = {
            rateWall60: 18500, rateWall70: 20500, rateWall80: 22500, rateWall90: 25000, rateWall100: 27500,
            rateGuideWall: 4500, rateWallChip: 1200, rateWallRebarBend: 1500,
            depthRatio: 2.0, thicknessRatio: 20, ratePavement: 1200, rateSettlingTank: 150000,
            supportHorizontalSpacing: 5, supportVerticalSpan: 3.5, platformRatio: 0.4,
            rateSupportM2: 850, rateSupportPostRent: 35000, rateSupportPostBuy: 55000,
            ratePlatformM2: 12000, rateMonitoring: 500,
            rateEarthworkM3: 650, rateRC_M3: 3100, ratePC_M3: 2500,
            rateForm_M2: 950, rateRebar_KG: 32.5, rateBasementMEP: 14000,
            rateBasementFinish: 6000,
            pileSpacing: 1.2, rateCappingBeam: 4500, rateLaggingBoard: 1150, ratePileUnit: 48000,
            b1HeightCustom: 4.2, typicalHeightCustom: 3.2, raftFoundationCustom: 2.5,
            unitRC_Raft: 1.15, unitForm_Raft: 1.36, unitRebar_Raft: 227,
            unitRC_B1: 0.85, unitForm_B1: 3.18, unitRebar_B1: 157,
            unitRC_Typ: 0.73, unitForm_Typ: 2.96, unitRebar_Typ: 145
        };

        const KEY_LABELS = {
            rateWall60: '60cm壁 (元/m²)', rateWall70: '70cm壁 (元/m²)', rateWall80: '80cm壁 (元/m²)',
            rateWall90: '90cm壁 (元/m²)', rateWall100: '100cm壁 (元/m²)', rateGuideWall: '導溝工程 (元/m)',
            rateWallChip: '劣質打除 (元/m)', rateWallRebarBend: '預留筋彎出 (元/m)',
            depthRatio: '連壁深度比 (倍)', thicknessRatio: '連壁厚度比 (1/N)',
            ratePavement: '舖面工程 (元/m²)', rateSettlingTank: '棄土沈澱池 (元/式)',
            supportHorizontalSpacing: '支撐水平間距 (m)', supportVerticalSpan: '支撐垂直跨距 (m)',
            platformRatio: '施工構台比例 (0~1)', rateSupportM2: '支撐費 (元/m²)',
            rateSupportPostRent: '中間樁租金 (元/支)', rateSupportPostBuy: '中間樁買斷 (元/支)',
            ratePlatformM2: '施工構台 (元/m²)', rateMonitoring: '安全觀測 (元/坪)',
            rateEarthworkM3: '土方清運 (元/m³)', rateRC_M3: '混凝土 (元/m³)',
            ratePC_M3: 'PC 混凝土 (元/m³)', rateForm_M2: '模板 (元/m²)',
            rateRebar_KG: '鋼筋 (元/kg)', rateBasementMEP: '機電 (元/坪)',
            rateBasementFinish: '裝修 (元/坪)',
            unitRC_Raft: '筏基混凝土用量', unitForm_Raft: '筏基模板用量', unitRebar_Raft: '筏基鋼筋用量',
            unitRC_B1: 'B1混凝土用量', unitForm_B1: 'B1模板用量', unitRebar_B1: 'B1鋼筋用量',
            unitRC_Typ: '標準層混凝土用量', unitForm_Typ: '標準層模板用量', unitRebar_Typ: '標準層鋼筋用量'
        };

        const GROUPS = {
            retaining: ['rateWall60', 'rateWall70', 'rateWall80', 'rateWall90', 'rateWall100', 'rateGuideWall', 'rateWallChip', 'rateWallRebarBend', 'depthRatio', 'thicknessRatio', 'ratePavement', 'rateSettlingTank'],
            support: ['supportHorizontalSpacing', 'supportVerticalSpan', 'platformRatio', 'rateSupportM2', 'rateSupportPostRent', 'rateSupportPostBuy', 'ratePlatformM2', 'rateMonitoring'],
            structural: ['rateEarthworkM3', 'rateRC_M3', 'ratePC_M3', 'rateForm_M2', 'rateRebar_KG', 'rateBasementMEP', 'rateBasementFinish'],
            usage: ['unitRC_Raft', 'unitForm_Raft', 'unitRebar_Raft', 'unitRC_B1', 'unitForm_B1', 'unitRebar_B1', 'unitRC_Typ', 'unitForm_Typ', 'unitRebar_Typ']
        };

        let regions = [{ id: 'north', name: '預設區域', ...DEFAULT_PARAMS }];
        let state = { retainingMethod: 'wall', belowUnitArea: 150, belowFloors: 3, belowPerimeter: 0, activeRegionId: 'north' };
        let db, auth, appId;

        async function initFirebase() {
            try {
                const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
                if (!configStr) { render(); return; }
                firebase.initializeApp(JSON.parse(configStr));
                auth = firebase.auth(); db = firebase.firestore();
                appId = typeof __app_id !== 'undefined' ? __app_id : 'basement-v57-stable';
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await auth.signInWithCustomToken(__initial_auth_token);
                else await auth.signInAnonymously();
                auth.onAuthStateChanged(user => {
                    if (user) {
                        document.getElementById('uid-display').innerText = user.uid;
                        listenToData(user.uid, appId);
                    }
                });
            } catch (err) { render(); }
        }

        function listenToData(uid, appId) {
            db.doc(`artifacts/${appId}/users/${uid}/settings/current`).onSnapshot(doc => { 
                if (doc.exists) { state = { ...state, ...doc.data() }; render(); } 
            });
            db.collection(`artifacts/${appId}/users/${uid}/regions`).onSnapshot(snap => {
                if (!snap.empty) {
                    regions = snap.docs.map(d => ({ id: d.id, ...DEFAULT_PARAMS, ...d.data() }));
                    render();
                } else {
                    const batch = db.batch();
                    regions.forEach(r => batch.set(db.doc(`artifacts/${appId}/users/${uid}/regions/${r.id}`), r));
                    batch.commit();
                }
            }, (err) => console.error(err));
        }

        async function saveData() {
            if (!auth || !auth.currentUser) return;
            await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/settings/current`).set(state);
        }

        async function updateRegionParam(key, value) {
            const val = parseInputNumber(value);
            const regIdx = regions.findIndex(r => r.id === state.activeRegionId);
            if (regIdx === -1) return;
            regions[regIdx][key] = val;
            if (db && auth.currentUser) await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/regions/${regions[regIdx].id}`).update({ [key]: val });
            render();
        }

        function updateState(key, value) {
            state[key] = isNaN(parseFloat(value)) ? value : parseFloat(value);
            render(); saveData();
        }

        function selectRegion(id) { state.activeRegionId = id; render(); saveData(); }

        function parseInputNumber(v) {
            if (typeof v === 'number') return v;
            if (!v) return 0;
            const cleaned = v.toString().replace(/,/g, '').replace(/[^\d.-]/g, '');
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        }

        function calculateRegion(reg) {
            if (!reg) reg = DEFAULT_PARAMS;
            const areaM2 = (state.belowUnitArea || 0) * PING_TO_M2;
            const floors = state.belowFloors || 0;
            const sysPerimeter = Math.round(Math.sqrt(areaM2) * 4);
            const finalPerimeter = (state.belowPerimeter > 0) ? state.belowPerimeter : sysPerimeter;

            const excavationDepth = (reg.b1HeightCustom || 4.2) + (Math.max(0, floors - 1) * (reg.typicalHeightCustom || 3.2)) + (reg.raftFoundationCustom || 2.5);
            const typMultiplier = Math.max(0, floors - 1);
            
            const totalRC = areaM2 * ((reg.unitRC_Raft || 0) + (reg.unitRC_B1 || 0) + (typMultiplier * (reg.unitRC_Typ || 0)));
            const totalForm = areaM2 * ((reg.unitForm_Raft || 0) + (reg.unitForm_B1 || 0) + (typMultiplier * (reg.unitForm_Typ || 0)));
            const totalRebar = areaM2 * ((reg.unitRebar_Raft || 0) + (reg.unitRebar_B1 || 0) + (typMultiplier * (reg.unitRebar_Typ || 0)));

            const isWall = state.retainingMethod === 'wall';
            let retainingCost = 0;

            if (isWall) {
                const wallThickness = Math.max(0.6, Math.round((excavationDepth / (reg.thicknessRatio || 20)) * 10) / 10);
                const wallDepth = excavationDepth * (reg.depthRatio || 2);
                let wallRate = reg.rateWall80;
                if (wallThickness >= 1.0) wallRate = reg.rateWall100;
                else if (wallThickness >= 0.9) wallRate = reg.rateWall90;
                else if (wallThickness <= 0.6) wallRate = reg.rateWall60;
                else if (wallThickness <= 0.7) wallRate = reg.rateWall70;
                retainingCost = (finalPerimeter * wallDepth * (wallRate || 0)) + (finalPerimeter * (reg.rateGuideWall || 0)) + (reg.rateSettlingTank || 0);
            } else {
                const pileCount = Math.ceil(finalPerimeter / (reg.pileSpacing || 1.2));
                retainingCost = (pileCount * (reg.ratePileUnit || 0)) + (finalPerimeter * (reg.rateCappingBeam || 0));
            }

            const structureCost = (totalRC * (reg.rateRC_M3 || 0)) + (totalForm * (reg.rateForm_M2 || 0)) + (totalRebar * (reg.rateRebar_KG || 0));
            const earthworkCost = areaM2 * excavationDepth * (reg.rateEarthworkM3 || 0);
            const otherCost = (state.belowUnitArea * floors) * ((reg.rateBasementMEP || 0) + (reg.rateBasementFinish || 0));
            
            const supportLayers = Math.ceil(excavationDepth / (reg.supportVerticalSpan || 3.5));
            const supportCost = areaM2 * supportLayers * (reg.rateSupportM2 || 0);

            const total = (retainingCost || 0) + (structureCost || 0) + (earthworkCost || 0) + (otherCost || 0) + (supportCost || 0);
            return { 
                physics: { excavationDepth, totalBelowBuildArea: state.belowUnitArea * floors, sysPerimeter, totalRC }, 
                total, 
                avg: (state.belowUnitArea * floors) > 0 ? total / (state.belowUnitArea * floors) : 0, 
                reg, 
                results: [
                    { l: "擋土工程預算", v: retainingCost, color: 'bg-indigo-500' },
                    { l: "結構主體工程", v: structureCost, color: 'bg-emerald-500' },
                    { l: "安全支撐工程", v: supportCost, color: 'bg-rose-500' },
                    { l: "土方及機電雜項", v: earthworkCost + otherCost, color: 'bg-amber-500' }
                ]
            };
        }

        function showToast(msg, isErr = false) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = `fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-xs font-black shadow-2xl transition-opacity z-50 ${isErr ? 'bg-rose-600' : 'bg-slate-900'} text-white`;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        }

        // --- Excel 功能 ---
        function exportToExcel() {
            const reg = regions.find(r => r.id === state.activeRegionId) || regions[0];
            const data = [
                ["參數類別", "參數代碼", "顯示名稱", "數值"],
                ["基本資訊", "region_name", "區域名稱", reg.name]
            ];

            // 合併所有參數組進行匯出
            const allKeys = [...GROUPS.retaining, ...GROUPS.support, ...GROUPS.structural, ...GROUPS.usage];
            allKeys.forEach(k => {
                let category = "細項單價";
                if (GROUPS.usage.includes(k)) category = "分層用量參數";
                else if (GROUPS.support.includes(k)) category = "支撐參數";
                data.push([category, k, KEY_LABELS[k] || k, reg[k]]);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, reg.name);
            XLSX.writeFile(workbook, `地下室參數_${reg.name}.xlsx`);
            showToast("Excel 匯出成功");
        }

        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                const regIdx = regions.findIndex(r => r.id === state.activeRegionId);
                if (regIdx === -1) return;

                const updates = {};
                rows.slice(1).forEach(row => {
                    const [cat, key, label, value] = row;
                    if (key === 'region_name') {
                        regions[regIdx].name = value;
                        updates.name = value;
                    } else if (key && value !== undefined) {
                        const numVal = parseFloat(value);
                        regions[regIdx][key] = isNaN(numVal) ? value : numVal;
                        updates[key] = regions[regIdx][key];
                    }
                });

                if (db && auth.currentUser) {
                    await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/regions/${regions[regIdx].id}`).update(updates);
                }
                
                showToast("Excel 數據匯入成功");
                render();
                event.target.value = ''; // 重置 file input
            };
            reader.readAsArrayBuffer(file);
        }

        function render() {
            const activeReg = regions.find(r => r.id === state.activeRegionId) || regions[0];
            const { physics, results, total, avg } = calculateRegion(activeReg);
            const numFmt = new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 });

            document.getElementById('total-budget').innerText = numFmt.format(total) + "元";
            document.getElementById('avg-cost').innerText = numFmt.format(avg) + "元";
            document.getElementById('current-region-label').innerText = activeReg.name;

            document.getElementById('region-list').innerHTML = regions.map(r => `
                <button onclick="selectRegion('${r.id}')" class="px-3 py-1.5 text-xs font-black rounded-lg border-2 transition-all ${state.activeRegionId === r.id ? 'region-tab-active shadow-sm' : 'border-slate-100 text-slate-400 hover:border-slate-300'}">${r.name}</button>
            `).join('');

            const rInputs = (id, ks) => {
                document.getElementById(id).innerHTML = ks.map(k => `
                    <div class="flex items-center justify-between group">
                        <label class="text-[11px] font-bold text-slate-400">${KEY_LABELS[k] || k}</label>
                        <input type="text" value="${activeReg[k] || 0}" onchange="updateRegionParam('${k}', this.value)" class="bg-[#1e293b] rounded-lg px-3 py-1.5 text-right text-xs font-black w-28 text-white outline-none focus:ring-1 ring-indigo-500">
                    </div>
                `).join('');
            };
            rInputs('retaining-rates-list', GROUPS.retaining);
            rInputs('support-params-list', GROUPS.support);
            rInputs('structural-rates-list', GROUPS.structural);

            const layers = [{id:'Raft (筏基)', p:'Raft'}, {id:'B1層', p:'B1'}, {id:'Typical (標準)', p:'Typ'}];
            document.getElementById('layer-usage-inputs').innerHTML = layers.map(l => `
                <div class="space-y-3 pt-4 border-t border-slate-100">
                    <span class="text-[10px] font-black text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded">${l.id} 用量/m²</span>
                    <div class="grid grid-cols-3 gap-3">
                        ${['RC', 'Form', 'Rebar'].map(type => `<div><label class="text-[8px] font-black text-slate-400">${type}</label>
                        <input type="text" value="${activeReg['unit'+type+'_'+l.p] || 0}" onchange="updateRegionParam('unit${type}_${l.p}', this.value)" class="w-full border-b py-1 text-xs font-black outline-none focus:border-indigo-500"></div>`).join('')}
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.input-group').forEach(el => {
                const k = el.dataset.key;
                const v = (k === 'belowPerimeter' && state[k] === 0) ? physics.sysPerimeter : state[k];
                el.innerHTML = `<label class="text-[9px] font-black text-slate-400 block mb-1">${el.dataset.label}</label>
                    <div class="relative"><input type="number" value="${v}" onchange="updateState('${k}', this.value)" class="w-full border rounded-xl px-4 py-2 text-sm font-black outline-none focus:border-indigo-500"><span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-300 font-black">${el.dataset.unit}</span></div>`;
            });

            document.getElementById('budget-body').innerHTML = results.map(r => `
                <tr class="hover:bg-slate-50 transition-colors"><td class="px-8 py-5 flex items-center gap-3"><div class="w-2 h-2 rounded-full ${r.color}"></div><span class="text-sm font-black text-slate-700">${r.l}</span></td><td class="px-8 py-5 text-xs text-slate-400 italic font-medium">概算統計結果</td><td class="px-8 py-5 text-right font-black text-slate-800">${numFmt.format(r.v)}元</td></tr>
            `).join('');

            document.getElementById('physics-cards').innerHTML = [
                { l: "預估開挖深度", v: (physics.excavationDepth || 0).toFixed(1) + " m", i: "layers" },
                { l: "總樓地板面積", v: Math.round(physics.totalBelowBuildArea || 0) + " 坪", i: "maximize" },
                { l: "建築計算週長", v: (state.belowPerimeter || physics.sysPerimeter || 0) + " m", i: "ruler" },
                { l: "RC 預估總量", v: Math.round(physics.totalRC || 0) + " m³", i: "droplets" }
            ].map(c => `<div class="bg-white p-4 rounded-2xl border shadow-sm"><div class="flex items-center gap-2 mb-2"><i data-lucide="${c.i}" class="w-3 h-3 text-slate-400"></i><span class="text-[9px] font-black text-slate-400 uppercase">${c.l}</span></div><div class="text-lg font-black text-slate-800">${c.v}</div></div>`).join('');

            lucide.createIcons();
            const isW = state.retainingMethod === 'wall';
            document.getElementById('btn-method-wall').className = `flex-1 py-2 text-xs font-black rounded-lg transition-all ${isW ? 'method-tab-active' : 'text-slate-400'}`;
            document.getElementById('btn-method-pile').className = `flex-1 py-2 text-xs font-black rounded-lg transition-all ${!isW ? 'method-tab-active' : 'text-slate-400'}`;
        }

        function openRegionModal() { document.getElementById('region-modal').classList.remove('hidden'); }
        function closeRegionModal() { document.getElementById('region-modal').classList.add('hidden'); }
        async function confirmAddRegion() {
            const name = document.getElementById('new-region-name').value.trim();
            if (!name) return;
            const nid = 'reg_' + Date.now();
            const nreg = { ...DEFAULT_PARAMS, id: nid, name: name };
            if (db && auth.currentUser) await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/regions/${nid}`).set(nreg);
            else regions.push(nreg);
            state.activeRegionId = nid; closeRegionModal(); render(); saveData();
        }

        async function editRegionName() {
            const r = regions.find(x => x.id === state.activeRegionId);
            const n = prompt("修改區域名稱：", r.name);
            if (n && n.trim()) { r.name = n.trim(); if (db && auth.currentUser) await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/regions/${r.id}`).update({ name: r.name }); render(); }
        }

        async function deleteCurrentRegion() {
            if (regions.length <= 1) return showToast("需保留至少一個區域", true);
            if (!confirm(`確定要刪除此區域單價庫嗎？`)) return;
            const id = state.activeRegionId;
            regions = regions.filter(x => x.id !== id);
            state.activeRegionId = regions[0].id;
            if (db && auth.currentUser) await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/regions/${id}`).delete();
            render(); saveData();
        }

        window.onload = () => { initFirebase(); render(); };
    </script>
</body>
</html>